<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FLOOD-XML Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    html, body { 
      height: 100%; margin: 0; 
      font-family: 'Inter', 'Segoe UI', -apple-system, sans-serif; 
      overflow: hidden; font-size: 14px; 
      font-weight: 400;
      background: #f8f9fa;
    }
    #map { height: 100%; width: 100%; z-index: 1; background: #e3f2fd; }

    .left-controls { 
      position: absolute; top: 20px; left: 20px; z-index: 1100; 
      display: flex; flex-direction: column; gap: 12px; width: 380px; 
    }
    
    .topbar, .legend, .stats-card { 
      background: rgba(255, 255, 255, 0.98); 
      backdrop-filter: blur(10px);
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 4px 16px rgba(0,0,0,0.12), 0 1px 3px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.06);
      transition: all 0.3s ease;
    }
    #legend { max-width: 260px; padding: 14px; }
    
    .topbar:hover, .legend:hover, .stats-card:hover {
      box-shadow: 0 8px 24px rgba(0,0,0,0.15), 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .topbar label { 
      font-size: 11px; font-weight: 600; color: #5f6368; 
      text-transform: uppercase; letter-spacing: 0.5px;
      display: block; margin-bottom: 8px; 
    }

    select, button { 
      width: 100%; padding: 10px 12px; border-radius: 8px; 
      border: 1.5px solid #e0e0e0; font-size: 14px; cursor: pointer; 
      font-family: inherit; background: white; transition: all 0.2s ease;
      font-weight: 500;
    }
    
    select:hover, button:hover { border-color: #1565c0; box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1); }
    button { background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white; border: none; font-weight: 600; }
    #clearBtn { background: linear-gradient(135deg, #ef5350 0%, #e53935 100%); }

    .sidebar { 
      position: absolute; top: 20px; right: 20px; z-index: 1100; 
      background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
      width: 380px; max-height: calc(100% - 360px); border-radius: 12px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.15), 0 2px 8px rgba(0,0,0,0.1);
      display: flex; flex-direction: column; animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    .sidebar.hidden { display: none; }
    .sidebar-body { padding: 20px; overflow-y: auto; flex-grow: 1; }

    .bottom-panel { 
      position: absolute; bottom: 20px; left: 420px; right: 420px;
      z-index: 1100; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
      height: 300px; border-radius: 12px; padding: 20px 30px; box-sizing: border-box;
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .bottom-panel.hidden { display: none; }

    /* VISITOR TAG STYLING */
    .visitor-tag {
      position: absolute; bottom: 20px; right: 20px; z-index: 2000;
      background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
      padding: 8px 16px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid rgba(0,0,0,0.08); display: flex; align-items: center; gap: 10px;
    }
    .status-dot {
      height: 8px; width: 8px; background-color: #00c853; border-radius: 50%;
      position: relative; box-shadow: 0 0 8px rgba(0, 200, 83, 0.6);
    }
    .status-dot::after {
      content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 100%;
      background-color: #00c853; border-radius: 50%; animation: status-pulse 2s infinite;
    }
    @keyframes status-pulse { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(3); opacity: 0; } }
    .visitor-text { display: flex; flex-direction: column; line-height: 1.1; }
    #visitor-count { font-size: 15px; font-weight: 800; color: #1a237e; }
    .label { font-size: 9px; font-weight: 700; color: #78909c; letter-spacing: 0.5px; }

    .legend-row { display: flex; align-items: center; gap: 10px; margin: 6px 0; font-size: 13px; }
    .swatch { width: 32px; height: 20px; border-radius: 6px; border: 1px solid rgba(0,0,0,0.15); }
    .brand { font-size: 20px; font-weight: 800; color: #1976d2; border-bottom: 3px solid #1976d2; margin-bottom: 16px; }

    @media (max-width: 768px) {
      html, body { overflow: auto; }
      .left-controls { left: 10px; top: 10px; width: calc(100% - 20px); }
      .sidebar, .bottom-panel { left: 10px; right: 10px; width: auto; }
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="left-controls">
  <div class="topbar">
    <div class="brand">üåä FLOOD-XML PORTAL</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
      <div>
        <label>AI/ML Model</label>
        <select id="modelSelect">
          <option value="ensemble">üìä Ensemble (median)</option>
          <option value="lm_USD">üìà MLR (Linear)</option>
          <option value="rf_USD">üå≤ Random Forest</option>
          <option value="xgb_USD">‚ö° XGBoost</option>
          <option value="svr_USD">üéØ SVR</option>
          <option value="brnn_USD">üß† BRNN</option>
          <option value="knn_USD">üîç KNN</option>
        </select>
      </div>
      <div>
        <label>Display Year</label>
        <select id="yearSelect"></select>
      </div>
    </div>
    <div style="margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
      <button id="dlCountry">üì• Download CSV</button>
      <button id="clearBtn">üîÑ Reset Map</button>
    </div>
  </div>

  <div id="legend" class="legend">
    <label style="font-weight: 600; font-size: 13px;">Total Annual Damages (USD)</label>
    <div id="legendItems"></div>
  </div>

  <div id="statsBox" class="stats-card hidden">
    <label style="font-weight: 600; font-size: 13px;">üìç Country Summary</label>
    <div id="countryStats" style="font-size: 14px; line-height: 1.6;"></div>
  </div>
</div>

<div id="sidebar" class="sidebar hidden">
  <div class="sidebar-body">
    <div id="countryName" style="font-size: 24px; font-weight: 700; margin-bottom: 16px;">Country</div>
    <label style="font-size: 11px; font-weight: 600;">Year Range</label>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
      <select id="startYear"></select>
      <select id="endYear"></select>
    </div>
    <div id="eventsList"></div>
  </div>
</div>

<div id="bottomPanel" class="bottom-panel hidden">
  <div id="chartHeader">
    <div>üìä Total Annual Damages (USD)</div>
    <button id="savePng">üíæ Export PNG</button>
  </div>
  <div style="height:220px; width:100%;"><canvas id="tsChart"></canvas></div>
</div>

<div class="visitor-tag">
  <div class="status-dot"></div>
  <div class="visitor-text">
    <span id="visitor-count">0</span>
    <span class="label">VISITORS</span>
  </div>
</div>

<script>
  // GLOBAL VISITOR COUNTER LOGIC
  const countEl = document.getElementById('visitor-count');
  const namespace = "flood_xml_portal_final_reset_001"; // Unique namespace starts it at 0
  const key = "visits";

  fetch(`https://api.counterapi.dev/v1/${namespace}/${key}/up`)
    .then(res => res.json())
    .then(data => { countEl.textContent = data.count.toLocaleString(); })
    .catch(() => {
      let sessionVisits = sessionStorage.getItem('session_visits') || 1;
      countEl.textContent = sessionVisits;
    });

  const BINS = [0, 1e6, 1e7, 1e8, 1e9, 1e10, 1e11];
  const COLORS = ["#d4c300", "#e6a300", "#f77f00", "#d62828", "#9d0208", "#6a040f", "#370617", "#03071e"];
  const BASE_MODELS = ["lm_USD", "rf_USD", "xgb_USD", "svr_USD", "brnn_USD", "knn_USD"];
  const NAME_TO_ISO = { "usa": "USA", "uk": "GBR", "russia": "RUS", "vietnam": "VNM", "south korea": "KOR" };

  let fullData = [], countriesGeo, eventsByIso = new Map(), years = [], chart, selectedIso = null;
  let eventMarkers = L.layerGroup();

  const el = id => document.getElementById(id);
  const map = L.map('map').setView([20, 0], 2);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
  eventMarkers.addTo(map);

  const formatUSD = n => n ? new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', notation: 'compact' }).format(n) : "$0";

  function getStats(rowOrArray) {
    const vals = Array.isArray(rowOrArray) ? rowOrArray.map(r => BASE_MODELS.map(m => parseFloat(r[m]) || 0)).flat() : BASE_MODELS.map(m => parseFloat(rowOrArray[m]) || 0);
    const sorted = vals.sort((a,b) => a-b);
    return { min: sorted[0] || 0, max: sorted[sorted.length-1] || 0, med: sorted[Math.floor(sorted.length/2)] || 0 };
  }

  async function init() {
    const [geoRes, csvRes] = await Promise.all([fetch('./data/countries.geojson'), fetch('./data/DFO21_damages_wt_EMDAT21.csv')]);
    countriesGeo = await geoRes.json();
    fullData = Papa.parse(await csvRes.text(), { header: true, skipEmptyLines: true }).data;

    fullData.forEach(row => {
      const y = parseInt(row.Began?.split('/')[0]);
      if (!y) return; years.push(y);
      let iso = NAME_TO_ISO[row.country?.toLowerCase().trim()];
      if (!iso) {
        const f = countriesGeo.features.find(feat => feat.properties.ADMIN?.toLowerCase() === row.country?.toLowerCase());
        iso = f ? f.properties.ISO_A3 || f.properties.ADM0_A3 : null;
      }
      if (iso && iso !== "-99") {
        if (!eventsByIso.has(iso)) eventsByIso.set(iso, { events: [], annual: {} });
        const entry = eventsByIso.get(iso);
        entry.events.push(row);
        if (!entry.annual[y]) entry.annual[y] = [];
        entry.annual[y].push(row);
      }
    });

    years = [...new Set(years)].sort();
    years.forEach(y => { el('yearSelect').add(new Option(y, y)); el('startYear').add(new Option(y, y)); el('endYear').add(new Option(y, y)); });
    el('yearSelect').value = years[years.length - 1]; el('endYear').value = years[years.length - 1];
    renderLegend(); updateMap();
  }

  function updateMap() {
    if (window.gLayer) map.removeLayer(window.gLayer);
    const yr = parseInt(el('yearSelect').value), mod = el('modelSelect').value;
    window.gLayer = L.geoJson(countriesGeo, {
      style: f => {
        const iso = f.properties.ISO_A3 || f.properties.ADM0_A3;
        const rows = eventsByIso.get(iso)?.annual[yr] || [];
        let val = (rows.length > 0) ? (mod === 'ensemble' ? getStats(rows).med : rows.reduce((s,r) => s + (parseFloat(r[mod])||0), 0)) : 0;
        return { fillColor: getColor(val), weight: 0.8, color: '#fff', fillOpacity: 0.85 };
      },
      onEachFeature: (f, l) => {
        l.on('click', () => {
          selectedIso = f.properties.ISO_A3 || f.properties.ADM0_A3;
          el('sidebar').classList.remove('hidden'); el('bottomPanel').classList.remove('hidden'); el('statsBox').classList.remove('hidden');
          el('countryName').textContent = f.properties.ADMIN;
          refreshUI();
        });
      }
    }).addTo(map);
  }

  function getColor(v) { 
    if (!v || v <= 0) return "#eceff1"; 
    for (let i = BINS.length-1; i>=0; i--) if (v >= BINS[i]) return COLORS[i]; 
    return COLORS[0]; 
  }

  function renderLegend() { 
    el('legendItems').innerHTML = BINS.map((b,i)=> `<div class="legend-row"><div class="swatch" style="background:${COLORS[i]}"></div><span>${formatUSD(b)}+</span></div>`).join(''); 
  }

  function refreshUI() {
    if (!selectedIso) return;
    const entry = eventsByIso.get(selectedIso), mod = el('modelSelect').value;
    eventMarkers.clearLayers();
    entry.events.forEach(e => {
        if (e.lat && e.lon) L.circleMarker([e.lat, e.lon], { radius: 6, color: '#333', fillColor: '#777', fillOpacity: 0.6 }).addTo(eventMarkers);
    });

    const dataset = years.map(y => {
        const rs = entry.annual[y] || [];
        return rs.reduce((sum, r) => sum + (mod === 'ensemble' ? getStats(r).med : (parseFloat(r[mod]) || 0)), 0);
    });

    if (chart) chart.destroy();
    chart = new Chart(el('tsChart'), {
      type: 'bar',
      data: { labels: years, datasets: [{ data: dataset, backgroundColor: '#1976d2', barThickness: 3 }] },
      options: { maintainAspectRatio: false, scales: { y: { type: 'logarithmic', min: 1e5 } }, plugins: { legend: { display: false } } }
    });
  }

  el('modelSelect').onchange = () => { updateMap(); if(selectedIso) refreshUI(); };
  el('yearSelect').onchange = updateMap;
  el('clearBtn').onclick = () => location.reload();
  init();
</script>
</body>
</html>
