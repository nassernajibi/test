<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Flood Damages Explorer - Ensemble Spread</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; overflow: hidden; }
    #map { height: 100%; width: 100%; z-index: 1; }
    .left-controls { position: absolute; top: 12px; left: 12px; z-index: 1100; display: flex; flex-direction: column; gap: 10px; width: 320px; }
    .topbar, .legend { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.2); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
    label { font-size: 11px; font-weight: 700; color: #555; text-transform: uppercase; }
    select, button { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 12px; cursor: pointer; }
    .sidebar { position: absolute; top: 12px; right: 12px; z-index: 1100; background: #fff; width: 340px; max-height: calc(100% - 240px); border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
    .sidebar.hidden { display: none; }
    .sidebar-body { padding: 15px; overflow-y: auto; flex-grow: 1; }
    .bottom-panel { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); z-index: 1100; background: #fff; width: 95%; height: 200px; border-radius: 10px; box-shadow: 0 -2px 15px rgba(0,0,0,0.2); padding: 10px 20px; }
    .bottom-panel.hidden { display: none; }
    .legend-row { display: flex; align-items: center; gap: 10px; margin: 5px 0; font-size: 12px; }
    .swatch { width: 20px; height: 14px; border-radius: 3px; border: 1px solid #999; }
    .event-item { padding: 10px 0; border-bottom: 1px solid #eee; font-size: 11px; }
    .pill { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
  </style>
</head>
<body>

<div id="map"></div>

<div class="left-controls">
  <div class="topbar">
    <div style="font-weight:800; font-size:16px; margin-bottom:10px;">Flood Damage Portal</div>
    <div class="row">
      <div>
        <label>Metric Model</label>
        <select id="modelSelect">
          <option value="ensemble">Ensemble (Med/Min/Max)</option>
          <option value="rf_USD">Random Forest</option>
          <option value="xgb_USD">XGBoost</option>
          <option value="lm_USD">MLR</option>
          <option value="svr_USD">SVR</option>
          <option value="brnn_USD">BRNN</option>
          <option value="knn_USD">KNN</option>
        </select>
      </div>
      <div>
        <label>Map Year</label>
        <select id="yearSelect"></select>
      </div>
    </div>
    <div class="row">
      <button id="clearBtn">Clear Map</button>
      <button id="dlCountry" style="background:#eef7ff; border-color:#bcd;">Export CSV</button>
    </div>
  </div>

  <div id="legend" class="legend">
    <div style="font-weight:bold; font-size:12px; margin-bottom:8px;">Annual Damage (USD)</div>
    <div id="legendItems"></div>
  </div>
</div>

<div id="sidebar" class="sidebar hidden">
  <div class="sidebar-body">
    <div id="countryName" style="font-weight:800; font-size:18px; margin-bottom:5px;">Country</div>
    <label>Time Range Filter</label>
    <div class="row" style="margin-bottom:15px;">
      <select id="startYear"></select>
      <select id="endYear"></select>
    </div>
    <div style="font-weight:bold; margin-bottom:10px; border-bottom:1px solid #eee;">Events in Selected Area</div>
    <div id="eventsList"></div>
  </div>
</div>

<div id="bottomPanel" class="bottom-panel hidden">
  <canvas id="tsChart"></canvas>
</div>

<script>
  const BINS = [0, 1e6, 1e7, 1e8, 1e9, 1e10, 1e11];
  const COLORS = ["#fff7ec", "#fee8c8", "#fdbb84", "#fc8d59", "#ef6548", "#d7301f", "#990000", "#4d0000"];
  const BASE_MODELS = ["rf_USD", "xgb_USD", "lm_USD", "svr_USD", "brnn_USD", "knn_USD"];
  
  // Robust Mapping for Dataset Consistency
  const NAME_TO_ISO = {
    "usa": "USA", "uk": "GBR", "united kingdom": "GBR", "russia": "RUS", "vietnam": "VNM",
    "south korea": "KOR", "iran": "IRN", "syria": "SYR", "bolivia": "BOL", "venezuela": "VEN",
    "tanzania": "TZA", "democratic republic of the congo": "COD", "republic of congo": "COG",
    "ivory coast": "CIV", "cote d'ivoire": "CIV", "laos": "LAO", "czech republic": "CZE",
    "trinidad": "TTO", "tobago": "TTO", "dominican republic": "DOM", "uae": "ARE"
  };

  let fullData = [], countriesGeo, eventsByIso = new Map(), years = [], chart, selectedIso = null;

  const el = id => document.getElementById(id);
  const map = L.map('map').setView([15, 10], 2);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

  const formatUSD = n => n ? new Intl.NumberFormat('en-US', { notation: 'compact', prefix: '$' }).format(n) : "$0";

  function getStats(rowOrArray) {
    const vals = Array.isArray(rowOrArray) 
      ? rowOrArray.map(r => BASE_MODELS.map(m => parseFloat(r[m]) || 0)).flat()
      : BASE_MODELS.map(m => parseFloat(rowOrArray[m]) || 0);
    
    const sorted = vals.sort((a,b) => a-b);
    return {
      min: sorted[0] || 0,
      max: sorted[sorted.length - 1] || 0,
      med: sorted[Math.floor(sorted.length / 2)] || 0
    };
  }

  async function init() {
    const [geoRes, csvRes] = await Promise.all([
      fetch('./data/countries.geojson'),
      fetch('./data/DFO21_damages_wt_EMDAT21.csv')
    ]);
    countriesGeo = await geoRes.json();
    const csvText = await csvRes.text();
    fullData = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;

    fullData.forEach(row => {
      const y = parseInt(row.Began?.split('/')[0]);
      if (!y) return;
      years.push(y);

      let iso = NAME_TO_ISO[row.country?.toLowerCase().trim()];
      if (!iso) {
        const f = countriesGeo.features.find(feat => 
          feat.properties.ADMIN?.toLowerCase() === row.country?.toLowerCase() || 
          feat.properties.NAME?.toLowerCase() === row.country?.toLowerCase()
        );
        iso = f ? (f.properties.ISO_A3 || f.properties.ADM0_A3) : null;
      }

      if (iso) {
        if (!eventsByIso.has(iso)) eventsByIso.set(iso, { events: [], annual: {} });
        const entry = eventsByIso.get(iso);
        entry.events.push(row);
        if (!entry.annual[y]) entry.annual[y] = [];
        entry.annual[y].push(row);
      }
    });

    years = [...new Set(years)].sort();
    years.forEach(y => {
      el('yearSelect').add(new Option(y, y));
      el('startYear').add(new Option(y, y));
      el('endYear').add(new Option(y, y));
    });
    el('yearSelect').value = years[years.length - 1];
    el('endYear').value = years[years.length - 1];

    renderLegend();
    updateMap();
  }

  function updateMap() {
    if (window.gLayer) map.removeLayer(window.gLayer);
    const yr = parseInt(el('yearSelect').value);
    const mod = el('modelSelect').value;

    window.gLayer = L.geoJson(countriesGeo, {
      style: f => {
        const iso = f.properties.ISO_A3 || f.properties.ADM0_A3 || NAME_TO_ISO[f.properties.ADMIN?.toLowerCase()];
        const dataRows = eventsByIso.get(iso)?.annual[yr] || [];
        let val = 0;
        if (dataRows.length > 0) {
          const stats = getStats(dataRows);
          val = (mod === 'ensemble') ? stats.med : dataRows.reduce((sum, r) => sum + (parseFloat(r[mod]) || 0), 0);
        }
        return { fillColor: getColor(val), weight: 1, color: 'white', fillOpacity: 0.8 };
      },
      onEachFeature: (f, l) => {
        l.on('click', () => {
          selectedIso = f.properties.ISO_A3 || f.properties.ADM0_A3 || NAME_TO_ISO[f.properties.ADMIN?.toLowerCase()];
          el('sidebar').classList.remove('hidden');
          el('bottomPanel').classList.remove('hidden');
          el('countryName').textContent = f.properties.ADMIN || f.properties.NAME;
          refreshUI();
        });
      }
    }).addTo(map);
  }

  function getColor(v) {
    if (!v || v <= 0) return "#e0e0e0";
    for (let i = BINS.length - 1; i >= 0; i--) if (v >= BINS[i]) return COLORS[i];
    return COLORS[0];
  }

  function renderLegend() {
    el('legendItems').innerHTML = BINS.map((b, i) => `
      <div class="legend-row">
        <div class="swatch" style="background:${COLORS[i]}"></div>
        <span>${BINS[i+1] ? formatUSD(b) + ' - ' + formatUSD(BINS[i+1]) : '> ' + formatUSD(b)}</span>
      </div>`).join('') + `<div class="legend-row"><div class="swatch" style="background:#e0e0e0"></div><span>No Damage</span></div>`;
  }

  function refreshUI() {
    if (!selectedIso) return;
    const model = el('modelSelect').value;
    const entry = eventsByIso.get(selectedIso);
    
    // Chart
    const dataset = years.map(y => {
      const rows = entry?.annual[y] || [];
      if (rows.length === 0) return { med: 0, min: 0, max: 0 };
      return getStats(rows);
    });

    if (chart) chart.destroy();
    
    const chartConfig = {
      labels: years,
      datasets: []
    };

    if (model === 'ensemble') {
      chartConfig.datasets.push({
        label: 'Median', data: dataset.map(d => d.med), borderColor: '#900', fill: false, z: 10
      }, {
        label: 'Range', data: dataset.map(d => d.max), fill: '+1', backgroundColor: 'rgba(200,0,0,0.1)', borderColor: 'transparent', pointRadius: 0
      }, {
        label: 'Min', data: dataset.map(d => d.min), fill: false, borderColor: 'transparent', pointRadius: 0
      });
    } else {
      chartConfig.datasets.push({
        label: model, data: dataset.map(d => d.med), borderColor: '#900', fill: true, backgroundColor: 'rgba(200,0,0,0.1)'
      });
    }

    chart = new Chart(el('tsChart'), {
      type: 'line',
      data: chartConfig,
      options: {
        maintainAspectRatio: false,
        scales: { y: { type: 'logarithmic', ticks: { callback: v => formatUSD(v) } } },
        plugins: { legend: { display: false } }
      }
    });

    // Event List
    const start = parseInt(el('startYear').value);
    const end = parseInt(el('endYear').value);
    const filtered = entry?.events.filter(e => {
      const y = parseInt(e.Began?.split('/')[0]);
      return y >= start && y <= end;
    }) || [];

    el('eventsList').innerHTML = filtered.map(e => `
      <div class="event-item">
        <strong>${e.Began}</strong> | <span class="pill">${e.MainCause}</span><br>
        Damage: ${formatUSD(getStats(e).med)} | Coords: ${e.lat}, ${e.lon}
      </div>`).join('');
  }

  // FIXED CSV DOWNLOAD
  el('dlCountry').onclick = () => {
    if (!selectedIso) return alert("Please select a country first");
    const data = eventsByIso.get(selectedIso).events;
    const csv = Papa.unparse(data);
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `flood_data_${selectedIso}.csv`;
    a.click();
  };

  el('modelSelect').onchange = () => { updateMap(); refreshUI(); };
  el('yearSelect').onchange = updateMap;
  el('startYear').onchange = refreshUI;
  el('endYear').onchange = refreshUI;
  el('clearBtn').onclick = () => { location.reload(); };

  init();
</script>
</body>
</html>
