<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FLOOD-XML Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    html, body { 
      height: 100%; margin: 0; 
      font-family: 'Aptos', 'Segoe UI', sans-serif; 
      overflow: hidden; font-size: 18px; 
      font-weight: 400;
    }
    #map { height: 100%; width: 100%; z-index: 1; background: #cad2d3; }

    .left-controls { position: absolute; top: 15px; left: 15px; z-index: 1100; display: flex; flex-direction: column; gap: 15px; width: 400px; }
    .topbar, .legend, .stats-card { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    
    .topbar label { font-size: 16px; font-weight: 700; color: #222; text-transform: uppercase; display: block; margin-bottom: 8px; }
    .topbar select, .topbar button, .topbar .brand { font-weight: 700 !important; }

    select, button { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #bbb; font-size: 17px; cursor: pointer; font-family: inherit; }
    button:hover { background: #f0f0f0; border-color: #900; }

    .sidebar { position: absolute; top: 15px; right: 15px; z-index: 1100; background: #fff; width: 400px; max-height: calc(100% - 320px); border-radius: 15px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
    .sidebar.hidden { display: none; }
    .sidebar-body { padding: 20px; overflow-y: auto; flex-grow: 1; }

    .bottom-panel { 
      position: absolute; bottom: 20px; 
      left: 430px; right: 430px;
      z-index: 1100; background: #fff; height: 300px; border-radius: 15px; 
      box-shadow: 0 -5px 25px rgba(0,0,0,0.4); padding: 20px 30px; box-sizing: border-box; 
    }
    .bottom-panel.hidden { display: none; }

    .legend-row { display: flex; align-items: center; gap: 12px; margin: 8px 0; font-size: 15px; }
    .swatch { width: 30px; height: 20px; border-radius: 4px; border: 1px solid #444; }
    
    .stats-card { border-left: 8px solid #800000; }
    .stat-val { font-size: 20px; color: #800000; }

    .event-item { padding: 12px 0; border-bottom: 1px solid #ddd; font-size: 14px; line-height: 1.6; }
    .pill { background: #ffebeb; color: #800000; padding: 3px 8px; border-radius: 5px; font-size: 11px; border: 1px solid #800000; }
    .coord-text { font-size: 11px; color: #777; font-style: italic; }
    
    #chartHeader { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  </style>
</head>
<body>

<div id="map"></div>

<div class="left-controls">
  <div class="topbar">
    <div class="brand" style="font-size:22px; color:#800000; margin-bottom:15px; border-bottom: 3px solid #800000;">FLOOD-XML PORTAL</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
      <div>
        <label>AI/ML Model</label>
        <select id="modelSelect">
          <option value="ensemble">Ensemble (median)</option>
          <option value="lm_USD">MLR (Linear)</option>
          <option value="rf_USD">Random Forest</option>
          <option value="xgb_USD">XGBoost</option>
          <option value="svr_USD">SVR</option>
          <option value="brnn_USD">BRNN</option>
          <option value="knn_USD">KNN</option>
        </select>
      </div>
      <div>
        <label>Display Year</label>
        <select id="yearSelect"></select>
      </div>
    </div>
    <div style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
      <button id="dlCountry" style="background:#f4f9ff;">Download CSV</button>
      <button id="clearBtn" style="background:#fff1f1;">Reset Map</button>
    </div>
  </div>

  <div id="legend" class="legend">
    <label style="font-weight: 400; text-transform: none;">Annual Damages (USD)</label>
    <div id="legendItems"></div>
  </div>

  <div id="statsBox" class="stats-card hidden">
    <label style="font-weight: 400; text-transform: none;">Country Summary</label>
    <div id="countryStats" style="font-size: 15px; line-height: 1.4;"></div>
  </div>
</div>

<div id="sidebar" class="sidebar hidden">
  <div class="sidebar-body">
    <div id="countryName" style="font-size:28px; color:#222; margin-bottom:10px;">Country</div>
    <label>Year Range</label>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:20px;">
      <select id="startYear"></select>
      <select id="endYear"></select>
    </div>
    <div style="font-size:16px; margin-bottom:12px; color:#444; border-bottom: 2px solid #eee;">EVENT ATTRIBUTES</div>
    <div id="eventsList"></div>
  </div>
</div>

<div id="bottomPanel" class="bottom-panel hidden">
  <div id="chartHeader">
    <div style="font-size:18px;">Annual Damages (USD)</div>
    <button id="savePng" style="width:auto; padding: 6px 15px; background:#e8f5e9; border-color:#2e7d32; font-weight:700 !important;">Export PNG</button>
  </div>
  <div style="height:200px; width:100%;"><canvas id="tsChart"></canvas></div>
</div>

<script>
  const BINS = [0, 1e6, 1e7, 1e8, 1e9, 1e10, 1e11];
  const COLORS = ["#d4c300", "#e6a300", "#f77f00", "#d62828", "#9d0208", "#6a040f", "#370617", "#03071e"];
  const BASE_MODELS = ["lm_USD", "rf_USD", "xgb_USD", "svr_USD", "brnn_USD", "knn_USD"];
  
  const NAME_TO_ISO = { "usa": "USA", "uk": "GBR", "russia": "RUS", "vietnam": "VNM", "south korea": "KOR" };

  let fullData = [], countriesGeo, eventsByIso = new Map(), years = [], chart, selectedIso = null;
  let eventMarkers = L.layerGroup();

  const el = id => document.getElementById(id);
  const map = L.map('map').setView([20, 0], 2);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
  eventMarkers.addTo(map);

  const formatUSD = n => n ? new Intl.NumberFormat('en-US', { notation: 'compact', prefix: '$' }).format(n) : "$0";

  function getStats(rowOrArray) {
    const vals = Array.isArray(rowOrArray) ? rowOrArray.map(r => BASE_MODELS.map(m => parseFloat(r[m]) || 0)).flat() : BASE_MODELS.map(m => parseFloat(rowOrArray[m]) || 0);
    const sorted = vals.sort((a,b) => a-b);
    return { min: sorted[0] || 0, max: sorted[sorted.length-1] || 0, med: sorted[Math.floor(sorted.length/2)] || 0 };
  }

  async function init() {
    const [geoRes, csvRes] = await Promise.all([fetch('./data/countries.geojson'), fetch('./data/DFO21_damages_wt_EMDAT21.csv')]);
    countriesGeo = await geoRes.json();
    fullData = Papa.parse(await csvRes.text(), { header: true, skipEmptyLines: true }).data;

    fullData.forEach(row => {
      const y = parseInt(row.Began?.split('/')[0]);
      if (!y) return;
      years.push(y);
      let iso = NAME_TO_ISO[row.country?.toLowerCase().trim()];
      if (!iso) {
        const f = countriesGeo.features.find(feat => feat.properties.ADMIN?.toLowerCase() === row.country?.toLowerCase() || feat.properties.NAME?.toLowerCase() === row.country?.toLowerCase());
        iso = f ? (f.properties.ISO_A3 || f.properties.ADM0_A3) : null;
      }
      if (iso && iso !== "-99") {
        if (!eventsByIso.has(iso)) eventsByIso.set(iso, { name: row.country, events: [], annual: {} });
        const entry = eventsByIso.get(iso);
        entry.events.push(row);
        if (!entry.annual[y]) entry.annual[y] = [];
        entry.annual[y].push(row);
      }
    });

    years = [...new Set(years)].sort();
    years.forEach(y => { el('yearSelect').add(new Option(y, y)); el('startYear').add(new Option(y, y)); el('endYear').add(new Option(y, y)); });
    el('yearSelect').value = years[years.length - 1]; el('endYear').value = years[years.length - 1];
    renderLegend(); updateMap();
  }

  function updateMap() {
    if (window.gLayer) map.removeLayer(window.gLayer);
    const yr = parseInt(el('yearSelect').value), mod = el('modelSelect').value;
    window.gLayer = L.geoJson(countriesGeo, {
      style: f => {
        const iso = f.properties.ISO_A3 || f.properties.ADM0_A3 || NAME_TO_ISO[f.properties.ADMIN?.toLowerCase()];
        const rows = eventsByIso.get(iso)?.annual[yr] || [];
        let val = (rows.length > 0) ? (mod === 'ensemble' ? getStats(rows).med : rows.reduce((s,r) => s + (parseFloat(r[mod])||0), 0)) : 0;
        return { fillColor: getColor(val), weight: 1.2, color: '#fff', fillOpacity: 0.9 };
      },
      onEachFeature: (f, l) => {
        l.on('click', () => {
          selectedIso = f.properties.ISO_A3 || f.properties.ADM0_A3 || NAME_TO_ISO[f.properties.ADMIN?.toLowerCase()];
          el('sidebar').classList.remove('hidden'); el('bottomPanel').classList.remove('hidden'); el('statsBox').classList.remove('hidden');
          el('countryName').textContent = f.properties.ADMIN || f.properties.NAME;
          refreshUI();
        });
      }
    }).addTo(map);
  }

  function getColor(v) { if (!v || v <= 0) return "#d4d4d4"; for (let i = BINS.length-1; i>=0; i--) if (v >= BINS[i]) return COLORS[i]; return COLORS[0]; }

  function renderLegend() { el('legendItems').innerHTML = BINS.map((b,i)=> `<div class="legend-row"><div class="swatch" style="background:${COLORS[i]}"></div><span>${BINS[i+1]?formatUSD(b)+' - '+formatUSD(BINS[i+1]):'> '+formatUSD(b)}</span></div>`).join('')+`<div class="legend-row"><div class="swatch" style="background:#d4d4d4"></div><span>No Recorded Damage</span></div>`; }

  function refreshUI() {
    if (!selectedIso) return;
    const entry = eventsByIso.get(selectedIso), mod = el('modelSelect').value;
    
    eventMarkers.clearLayers();
    entry.events.forEach(e => {
      if (e.lat && e.lon) {
        const dmg = mod === 'ensemble' ? getStats(e).med : (parseFloat(e[mod]) || 0);
        const deathVal = e.dead || e.deaths || 0; // Fixed mapping
        L.circleMarker([e.lat, e.lon], { radius: 8, color: '#333', weight: 1, fillColor: '#ffff00', fillOpacity: 1 })
        .addTo(eventMarkers).bindTooltip(`
          <b>${e.MainCause}</b><br>
          Began: ${e.Began}<br>Ended: ${e.Ended}<br>
          Duration: ${e.duration} days<br>Deaths: ${deathVal}<br>
          Area: ${e.area} km²<br>Damage: ${formatUSD(dmg)}
        `);
      }
    });

    const dataset = years.map(y => { 
        const rs = entry?.annual[y] || []; 
        return rs.length === 0 ? {med:0,min:0,max:0, count:0} : {...getStats(rs), count: rs.length}; 
    });

    if (chart) chart.destroy();

    const whiskerPlugin = {
      id: 'whiskers',
      afterDatasetsDraw(chart) {
        if (el('modelSelect').value !== 'ensemble') return;
        const {ctx, scales: {x, y}} = chart;
        ctx.save();
        ctx.strokeStyle = '#ff0000'; ctx.lineWidth = 2;
        dataset.forEach((d, i) => {
          if (d.med === 0) return;
          const xPos = x.getPixelForValue(years[i]);
          const yMin = y.getPixelForValue(d.min || d.med);
          const yMax = y.getPixelForValue(d.max || d.med);
          ctx.beginPath(); ctx.moveTo(xPos, yMin); ctx.lineTo(xPos, yMax); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(xPos - 6, yMin); ctx.lineTo(xPos + 6, yMin); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(xPos - 6, yMax); ctx.lineTo(xPos + 6, yMax); ctx.stroke();
        });
        ctx.restore();
      }
    };

    chart = new Chart(el('tsChart'), {
      type: 'bar',
      data: {
        labels: years,
        datasets: [{
          data: dataset.map(d => d.med),
          backgroundColor: '#000000',
          borderColor: '#000',
          borderWidth: 1
        }]
      },
      options: {
        maintainAspectRatio: false,
        scales: { y: { type: 'logarithmic', min: 1e5, ticks: { callback: v => formatUSD(v) } } },
        plugins: { 
            legend: { display: false },
            tooltip: {
                callbacks: {
                    afterBody: (context) => {
                        const idx = context[0].dataIndex;
                        return `Events: ${dataset[idx].count}`;
                    }
                }
            }
        }
      },
      plugins: [whiskerPlugin]
    });

    const s = parseInt(el('startYear').value), eY = parseInt(el('endYear').value);
    const filtered = entry.events.filter(e => { const y = parseInt(e.Began?.split('/')[0]); return y >= s && y <= eY; });
    el('eventsList').innerHTML = filtered.map(ev => {
      const dmg = mod === 'ensemble' ? getStats(ev).med : (parseFloat(ev[mod]) || 0);
      const deathVal = ev.dead || ev.deaths || 0; // Fixed mapping
      return `<div class="event-item">
        <span class="pill">${ev.Began} - ${ev.Ended}</span><br>
        <b>${ev.MainCause}</b><br>
        Duration: ${ev.duration} days | Deaths: ${deathVal}<br>
        Area: ${ev.area} km² | Damage: ${formatUSD(dmg)}<br>
        <span class="coord-text">Coords: ${ev.lat}, ${ev.lon}</span>
      </div>`;
    }).join('');
    
    const totalArea = entry.events.reduce((s,e)=>s+(parseFloat(e.area)||0),0);
    const totalDeaths = entry.events.reduce((s,e)=>s+(parseFloat(e.dead || e.deaths)||0),0); // Fixed mapping
    el('countryStats').innerHTML = `
        Events: <span class="stat-val">${entry.events.length}</span><br>
        Total Deaths: <span class="stat-val">${totalDeaths}</span><br>
        Total Area: <span class="stat-val">${formatUSD(totalArea).replace('$','')} km²</span>
    `;
  }

  el('savePng').onclick = () => {
    const link = document.createElement('a');
    link.download = `FLOOD-CHART-${el('countryName').textContent}.png`;
    link.href = el('tsChart').toDataURL('image/png'); link.click();
  };

  el('dlCountry').onclick = () => {
    if (!selectedIso) return alert("Select a country.");
    const csv = Papa.unparse(eventsByIso.get(selectedIso).events);
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
    a.download = `FLOOD-XML-${el('countryName').textContent.replace(/\s+/g, '-')}.csv`;
    a.click();
  };

  el('modelSelect').onchange = () => { updateMap(); if(selectedIso) refreshUI(); };
  el('yearSelect').onchange = updateMap;
  el('startYear').onchange = refreshUI; el('endYear').onchange = refreshUI;
  el('clearBtn').onclick = () => location.reload();
  init();
</script>
</body>
</html>
